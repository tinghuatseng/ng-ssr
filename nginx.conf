# /path/to/your/project/nginx.conf

# 設定工作進程數，通常設定為 CPU 核心數
worker_processes auto;

events {
    # 每個工作進程的最大連線數
    worker_connections 1024;
}

http {
    # 引入標準的 MIME 類型定義
    include /etc/nginx/mime.types;
    # 預設檔案類型
    default_type application/octet-stream;

    # 開啟高效檔案傳輸模式
    sendfile on;
    # 防止網路壅塞
    tcp_nopush on;

    # 連線逾時時間
    keepalive_timeout 65;

    # 開啟 Gzip 壓縮，優化傳輸
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # 定義我們的伺服器
    server {
        # 監聽 80 埠
        listen 80;
        # 伺服器名稱，這裡使用 localhost
        server_name localhost;

        # 您的 Angular 應用程式建置後，靜態檔案所在的根目錄
        # 注意：這個路徑是 Docker 容器內的路徑
        root /usr/share/nginx/html;

        # 預設首頁檔案
        index index.html index.htm;

        # 處理靜態檔案和 SSR 路由的核心邏輯
        location / {
            # 嘗試按順序尋找檔案：
            # 1. $uri：尋找與請求 URI 完全相符的檔案 (例如 /main.js)
            # 2. $uri/index.html：直接尋找預渲染頁面的 index.html (例如 /about/index.html)
            # 3. @proxy：如果都找不到，則將請求交給名為 @proxy 的內部 location 處理
            try_files $uri $uri/index.html @proxy;
        }

        # 專門處理根路徑 "/" 的請求，直接交給後端處理重定向
        location = / {
            # 將請求轉發到名為 'app' 的服務容器的 4000 埠
            proxy_pass http://app:4000;

            # 設定必要的標頭，以便後端應用能獲取真實的客戶端資訊
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 處理媒體檔案，設定較長的瀏覽器快取時間
        location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|htc)$ {
            expires 1M;
            access_log off;
            add_header Cache-Control "public";
        }

        # 處理 JS 和 CSS 檔案，設定較長的瀏覽器快取時間
        location ~* \.(?:css|js)$ {
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        # 內部 location，用於將請求代理到 Angular SSR 伺服器
        location @proxy {
            # 將請求轉發到名為 'app' 的服務容器的 4000 埠
            proxy_pass http://app:4000;

            # 設定必要的標頭，以便後端應用能獲取真實的客戶端資訊
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
